<aetgt:getResponse xmlns:aetgt="http://schemas.active-endpoints.com/appmodules/repository/2010/10/avrepository.xsd"
                   xmlns:types1="http://schemas.active-endpoints.com/appmodules/repository/2010/10/avrepository.xsd">
   <types1:Item>
      <types1:EntryId>7qaaaa-gt-957994-2023-02-28T13:08:17.944Z::pd.xml</types1:EntryId>
      <types1:Name>Process_BankClearing_SapB1-SapS4</types1:Name>
      <types1:ParentFlowIds>0wbgdwUiQLnzYLn-gt-4572362-2023-02-28T13:08:18.996Z::pd.xml</types1:ParentFlowIds>
      <types1:MimeType>application/xml+process</types1:MimeType>
      <types1:Description/>
      <types1:AppliesTo/>
      <types1:Tags>.agent:VIP_IICS_SA_SG_ONPREM_GROUP</types1:Tags>
      <types1:VersionLabel>1.0</types1:VersionLabel>
      <types1:State>CURRENT</types1:State>
      <types1:ProcessGroup/>
      <types1:CreatedBy>veerabh-vistra-tst</types1:CreatedBy>
      <types1:CreationDate>2023-02-28T13:08:18Z</types1:CreationDate>
      <types1:ModifiedBy>anupama.rao@vistra.com.SAML</types1:ModifiedBy>
      <types1:ModificationDate>2023-03-16T15:16:06Z</types1:ModificationDate>
      <types1:PublicationStatus>out-of-date</types1:PublicationStatus>
      <types1:PublishedBy>anupama.rao@vistra.com.SAML</types1:PublishedBy>
      <types1:PublicationDate>2023-03-16T15:17:28Z</types1:PublicationDate>
      <types1:PublishedContributionId>project:/spi.Process_BankClearing_SapB1-SapS4/Process_BankClearing_SapB1-SapS4.pd.xml</types1:PublishedContributionId>
      <types1:AutosaveExists>false</types1:AutosaveExists>
      <types1:Entry>
         <process xmlns="http://schemas.active-endpoints.com/appmodules/screenflow/2010/10/avosScreenflow.xsd"
                  xmlns:tfm="http://schemas.active-endpoints.com/appmodules/screenflow/2021/04/taskflowModel.xsd"
                  xmlns:list="urn:activevos:spi:list:functions"
                  displayName="Process_BankClearing_SapB1-SapS4"
                  name="Process_BankClearing_SapB1-SapS4"
                  overrideAPIName="false">
            <parameterSet xmlns="http://schemas.active-endpoints.com/appmodules/screenflow/2021/04/taskflowModel.xsd"/>
            <appliesTo/>
            <description/>
            <tags>.agent:VIP_IICS_SA_SG_ONPREM_GROUP</tags>
            <generator>Informatica Process Designer 11</generator>
            <input>
               <parameter description="Data from either SAB B1, or the API_20_JournalClearing_retry (VIPIntegrations.CF)"
                          name="in_Payload"
                          required="true"
                          type="objectlist">
                  <options>
                     <option name="referenceTo">$po:PoCfBankClearing</option>
                     <option hide="true" name="multiSelect">true</option>
                     <option name="required">false</option>
                     <option name="isCopy">true</option>
                     <option name="guid">0JVqzomCOu8bVwS3drDw0P</option>
                  </options>
               </parameter>
               <parameter description="Unique ID of the transaction (this can be generated by the source system or manually entered)"
                          name="in_X_TRANSACTION_ID"
                          required="true"
                          type="string">
                  <options>
                     <option name="required">false</option>
                  </options>
               </parameter>
               <parameter description="The name of the event that caused the API to start (e.g. Matter_Created)"
                          name="in_EventName"
                          required="true"
                          type="string">
                  <options>
                     <option name="required">false</option>
                  </options>
               </parameter>
               <parameter description="Process ID of the parent process"
                          name="in_IICS_Process_ID"
                          required="true"
                          type="string">
                  <options>
                     <option name="required">false</option>
                  </options>
               </parameter>
               <parameter description="The name of the API started by the event (e.g. API-08)"
                          name="in_ApiName"
                          required="true"
                          type="string">
                  <options>
                     <option name="required">false</option>
                  </options>
               </parameter>
               <parameter description="" name="in_DataKey" required="true" type="string">
                  <options>
                     <option name="required">false</option>
                  </options>
               </parameter>
               <parameter description="" name="in_ParentProcess_StartTime" type="datetime">
                  <options>
                     <option name="thirtyMinutesIncrement">true</option>
                     <option name="required">false</option>
                  </options>
               </parameter>
            </input>
            <output>
               <field description="" name="out_Final_Status" type="string">
                  <options>
                     <option name="required">false</option>
                  </options>
               </field>
               <field description="" name="out_Final_FailedAtStep" type="string">
                  <options>
                     <option name="required">false</option>
                  </options>
               </field>
               <field description="" name="out_Final_Message" type="string">
                  <options>
                     <option name="required">false</option>
                  </options>
               </field>
               <field description="" name="out_Final_FailureCount" type="string">
                  <options>
                     <option name="required">false</option>
                  </options>
               </field>
            </output>
            <tempFields>
               <field description=""
                      name="tmp_JournalEntryCreateRequest"
                      type="reference">
                  <options>
                     <option name="referenceTo">$po:$any</option>
                     <option name="required">false</option>
                     <option name="isCopy">true</option>
                  </options>
               </field>
               <field description="" name="tmp_SapCredentials" type="reference">
                  <options>
                     <option name="referenceTo">$po:PoSapCredentials-2</option>
                     <option name="required">false</option>
                     <option name="isCopy">true</option>
                     <option name="guid">8kAPgiRg8pdcYM9AY5VEAM</option>
                  </options>
               </field>
               <field description="" name="tmp_CreateItem_JE" type="reference">
                  <options>
                     <option name="referenceTo">$po:$any</option>
                     <option name="required">false</option>
                     <option name="isCopy">true</option>
                  </options>
               </field>
               <field description="" name="tmp_S4Bank_Count" type="int">
                  <options>
                     <option name="required">false</option>
                  </options>
               </field>
               <field description=""
                      name="tmp_JournalEntryClearingRequest"
                      type="reference">
                  <options>
                     <option name="referenceTo">$po:$any</option>
                     <option name="required">false</option>
                     <option name="isCopy">true</option>
                  </options>
               </field>
               <field description="" name="tmp_ClearingItem_JE" type="reference">
                  <options>
                     <option name="referenceTo">$po:$any</option>
                     <option name="required">false</option>
                     <option name="isCopy">true</option>
                  </options>
               </field>
               <field description="" name="tmp_MatchingItemsFeedback" type="reference">
                  <options>
                     <option name="referenceTo">AppSvcJournalEntryCreateRequestConfirmation-In:JournalEntryCreateConfirmationBulkMessage</option>
                     <option name="required">false</option>
                     <option name="isCopy">true</option>
                     <option name="guid">bbOXMeh0JeJkuj45JTCtCp</option>
                  </options>
               </field>
               <field description="" name="tmp_FailedAtStep_Reason" type="string">
                  <options>
                     <option name="required">false</option>
                  </options>
               </field>
               <field description="" name="tmp_MessageID" type="string">
                  <options>
                     <option name="required">false</option>
                  </options>
               </field>
               <field description="" name="tmp_VIP_FailedLog_Record" type="reference">
                  <options>
                     <option name="referenceTo">AppConnVIPIntegrations-CF:api_20_Failure_Log</option>
                     <option name="required">false</option>
                     <option name="guid">4jeLzcggRQkghEFjkshE2U</option>
                  </options>
               </field>
               <field description="" name="tmp_IICS_Status" type="string">
                  <options>
                     <option name="required">false</option>
                  </options>
               </field>
               <field description="" name="tmp_JournalPosting_Status" type="string">
                  <options>
                     <option name="required">false</option>
                  </options>
               </field>
               <field description="" name="tmp_CreatedBy" type="string">
                  <options>
                     <option name="required">false</option>
                     <option name="initialvalue">CC0000000022</option>
                  </options>
               </field>
               <field description="" name="tmp_Reference2" type="string">
                  <options>
                     <option name="required">false</option>
                     <option name="initialvalue">SAPB1-API-20</option>
                  </options>
               </field>
               <field description="" name="tmp_IICS_Process_ID" type="string">
                  <options>
                     <option name="required">false</option>
                  </options>
               </field>
               <field description="" name="tmp_PreviousFailure_Status" type="string">
                  <options>
                     <option name="required">false</option>
                  </options>
               </field>
               <field description=""
                      name="tmp_PreviousFailure_FailedAtStep"
                      type="string">
                  <options>
                     <option name="required">false</option>
                  </options>
               </field>
               <field description="" name="tmp_FailureReason" type="string">
                  <options>
                     <option name="required">false</option>
                  </options>
               </field>
               <field description="" name="tmp_FailedAtStep" type="string">
                  <options>
                     <option name="required">false</option>
                  </options>
               </field>
               <field description="" name="tmp_JournalFetch_Status" type="string">
                  <options>
                     <option name="required">false</option>
                  </options>
               </field>
            </tempFields>
            <notes/>
            <deployment skipIfRunning="false" suspendOnFault="false" tracingLevel="verbose">
               <targetLocation>VIP_IICS_SA_SG_ONPREM_GROUP</targetLocation>
               <rest/>
            </deployment>
            <flow id="a">
               <start id="b">
                  <link id="le2osod0" targetId="lb0ft5ga"/>
               </start>
               <assignment id="lb0ft5ga">
                  <title>Prepare S4 Payload for Journal Entry</title>
                  <operation source="formula" to="temp.tmp_MessageID">
                     <expression language="XQuery">fn:substring(fn:substring-before(fn:replace($input.in_Payload[1]/ValueDate,'-',''),'T')||'~'||$input.in_Payload[1]/BankRef||
'~'||fn:abs($input.in_Payload[1]/AmountReceived), 1, 35)</expression>
                  </operation>
                  <operation source="formula" to="temp.tmp_CreateItem_JE">
                     <expression language="XQuery">let $GL1 := $input.in_Payload[1]/GL_CashReceipt_S4 
let $GL2 := $input.in_Payload[1]/GL_Target_S4 

for $GL in ($GL1, $GL2) return
&lt;Item&gt;	
	&lt;ReferenceDocumentItem&gt;{util:iif($GL = $input.in_Payload[1]/GL_CashReceipt_S4, 1, 2)}&lt;/ReferenceDocumentItem&gt;
	&lt;GLAccount&gt;{$GL}&lt;/GLAccount&gt;
	&lt;AmountInTransactionCurrency currencyCode="{$input.in_Payload[1]/BankCurrency/text()}"&gt;{util:iif($GL = $input.in_Payload[1]/GL_Target_S4, fn:format-number((-1) * $input.in_Payload[1]/AmountReceived , '#0.##'), fn:format-number($input.in_Payload[1]/AmountReceived, '#0.##'))}&lt;/AmountInTransactionCurrency&gt; 
	&lt;CompanyCode&gt;{$input.in_Payload[1]/CompanyCode/text()}&lt;/CompanyCode&gt;
&lt;/Item&gt;</expression>
                  </operation>
                  <operation source="formula" to="temp.tmp_JournalEntryCreateRequest">
                     <expression language="XQuery">&lt;soap:Envelope xmlns:soap="http://schemas.xmlsoap.org/soap/envelope/"&gt;
    &lt;soap:Header/&gt;
    &lt;soap:Body&gt;
        &lt;ns:JournalEntryBulkCreateRequest xmlns:ns="http://sap.com/xi/SAPSCORE/SFIN"&gt;
            &lt;MessageHeader&gt;
                &lt;ID&gt;
{$temp.tmp_MessageID/text()}&lt;/ID&gt;
                &lt;CreationDateTime&gt;{fn:current-dateTime()}&lt;/CreationDateTime&gt;
				&lt;SenderBusinessSystemId&gt;VIP&lt;/SenderBusinessSystemId&gt;
                &lt;TestDataIndicator&gt;false&lt;/TestDataIndicator&gt;
            &lt;/MessageHeader&gt;
            &lt;JournalEntryCreateRequest&gt;
                &lt;MessageHeader&gt;
                    &lt;ID&gt;{$temp.tmp_MessageID/text()} &lt;/ID&gt;
                    &lt;CreationDateTime&gt;{$input.in_Payload[1]/PostDate}&lt;/CreationDateTime&gt;                    
                &lt;/MessageHeader&gt;
                &lt;JournalEntry&gt;
                    &lt;OriginalReferenceDocumentType&gt;BKPFF&lt;/OriginalReferenceDocumentType&gt;
                    &lt;DocumentHeaderText&gt;CASH RECEIPT_B1_BV907&lt;/DocumentHeaderText&gt;
                    &lt;BusinessTransactionType&gt;RFBU&lt;/BusinessTransactionType&gt;
                    &lt;AccountingDocumentType&gt;DZ&lt;/AccountingDocumentType&gt;                   
                    &lt;DocumentReferenceID&gt;{$input.in_Payload[1]/BankRef/text() }&lt;/DocumentReferenceID&gt;                                    
                    &lt;CreatedByUser&gt;{$temp.tmp_CreatedBy/text()}&lt;/CreatedByUser&gt;
                    &lt;CompanyCode&gt;{$input.in_Payload[1]/CompanyCode/text() }&lt;/CompanyCode&gt;                    
                    &lt;DocumentDate&gt;
                    {substring-before($input.in_Payload[1]/ValueDate,'T') }&lt;/DocumentDate&gt;                    
                    &lt;PostingDate&gt;{substring-before($input.in_Payload[1]/PostDate,'T') }&lt;/PostingDate&gt;                    
                    &lt;Reference1InDocumentHeader&gt;{$input.in_Payload[1]/B1_Ref_ID/text() }&lt;/Reference1InDocumentHeader&gt;                    
                    &lt;Reference2InDocumentHeader&gt;{$temp.tmp_Reference2/text()}&lt;/Reference2InDocumentHeader&gt;
                    {$temp.tmp_CreateItem_JE}
                &lt;/JournalEntry&gt;
            &lt;/JournalEntryCreateRequest&gt;
        &lt;/ns:JournalEntryBulkCreateRequest&gt;
    &lt;/soap:Body&gt;
&lt;/soap:Envelope&gt;</expression>
                  </operation>
                  <operation source="formula" to="temp.tmp_SapCredentials">
                     <expression language="XQuery">&lt;PoSapCredentials&gt;
   &lt;hostname&gt;{util:resolveURN('URN_SAP_Hostname')}&lt;/hostname&gt;
   &lt;username&gt;{util:resolveURN('URN_SAP_Username')}&lt;/username&gt;
   &lt;password&gt;{util:resolveURN('URN_SAP_Pwd')}&lt;/password&gt;
&lt;/PoSapCredentials&gt;
</expression>
                  </operation>
                  <operation source="formula" to="temp.tmp_IICS_Process_ID">
                     <expression language="XQuery">'Parent=' || $input.in_IICS_Process_ID || '^LoggedAt=' || util:getProcessId() || '^'</expression>
                  </operation>
                  <operation source="query" to="temp.tmp_VIP_FailedLog_Record">
                     <query advanceQuery="true" from="AppConnVIPIntegrations-CF:api_20_Failure_Log">
                        <where>B1_Ref_ID = '{$input.in_Payload[1]/B1_Ref_ID}' Order By DateCreated desc</where>
                     </query>
                  </operation>
                  <link id="lfayjzyw" targetId="lfb32y7o"/>
               </assignment>
               <assignment id="lfayk02n">
                  <title>Check for multiple Bank Statements</title>
                  <operation source="formula" to="temp.tmp_S4Bank_Count">
                     <expression language="XQuery">list:count($output.gET_A_OperationalAcctgDocItemCubeResponse/d/results )</expression>
                  </operation>
                  <link id="lfayk0lv" targetId="lfayk0j8"/>
               </assignment>
               <eventContainer id="lfb32y7o">
                  <service id="lfayjzyv">
                     <title>Fetch Bank Statement from S4</title>
                     <serviceName>AppsvcSapS4-AccountingDocumentRead-Custom:GET_A_OperationalAcctgDocItemCube</serviceName>
                     <serviceGUID>3VZyEkGkNjxcf47SnZiTww</serviceGUID>
                     <serviceInput>
                        <parameter name="hostname" source="field" updatable="true">temp.tmp_SapCredentials[1]/hostname</parameter>
                        <parameter name="username" source="field" updatable="true">temp.tmp_SapCredentials[1]/username</parameter>
                        <parameter name="password" source="field" updatable="true">temp.tmp_SapCredentials[1]/password</parameter>
                        <parameter name="CompanyCode" source="field" updatable="true">input.in_Payload[1]/CompanyCode</parameter>
                        <parameter name="BankRef" source="field" updatable="true">input.in_Payload[1]/BankRef</parameter>
                        <parameter name="AmountInTransactionCurrency" source="formula">
                           <expression language="XQuery">fn:format-number((-1) * $input.in_Payload[1]/AmountReceived , '#0.##')</expression>
                        </parameter>
                        <parameter name="PostingDate" source="formula">
                           <expression language="XQuery">fn:replace($input.in_Payload[1]/PostDate , 'Z', '.000')</expression>
                        </parameter>
                        <parameter name="DocumentItemText" source="field" updatable="true">input.in_Payload[1]/DocumentItemText</parameter>
                     </serviceInput>
                  </service>
                  <flow id="lfb32y7q">
                     <link id="lfb32y7r" targetId="lfb32y7o" type="containerLink"/>
                  </flow>
                  <flow id="lfb32y7t">
                     <assignment id="lfb32ywa">
                        <title>Set Bank Statement Fetch Failure</title>
                        <operation source="constant" to="temp.tmp_IICS_Status">Failed</operation>
                        <operation source="constant" to="temp.tmp_FailedAtStep">Fetch Bank Statement from S4</operation>
                        <operation source="formula" to="temp.tmp_FailureReason">
                           <expression language="XQuery">$output.BS_faultInfo[1]/reason ||'; '||$output.BS_faultInfo[1]/detail </expression>
                        </operation>
                        <link id="lfb32z8d" targetId="lfb32z8c"/>
                     </assignment>
                     <subflow id="lfb32z8c">
                        <title>Log Bank Statement Fetch Error</title>
                        <subflowGUID>7N5uKhvv6kXg3zoRAbuggF</subflowGUID>
                        <subflowPath>Process_P2B_Event_ErrorLog</subflowPath>
                        <runForEach>false</runForEach>
                        <input>
                           <parameter name="i_X_TRANSACTION_ID" source="constant" updatable="true">{$input.in_X_TRANSACTION_ID}</parameter>
                           <parameter name="i_IICS_Run_ID" source="field" updatable="true">temp.tmp_IICS_Process_ID</parameter>
                           <parameter name="i_Code" source="field" updatable="true">output.BS_faultInfo[1]/code</parameter>
                           <parameter name="i_Error" source="field" updatable="true">output.BS_faultInfo[1]/reason</parameter>
                           <parameter name="i_Description" source="field" updatable="true">output.BS_faultInfo[1]/detail</parameter>
                           <parameter name="i_APIName" source="constant" updatable="true">{$input.in_ApiName}</parameter>
                           <parameter name="i_EventName" source="constant" updatable="true">{$input.in_EventName}</parameter>
                           <parameter name="i_DataKey" source="constant" updatable="true">{$input.in_DataKey}</parameter>
                           <parameter name="i_IICSProcessname" source="formula" updatable="true">
                              <expression language="XQuery">util:getAssetName()</expression>
                           </parameter>
                           <parameter name="i_FailedAtStep" source="constant" updatable="true">{$temp.tmp_FailedAtStep}</parameter>
                           <parameter name="i_RestURL" source="constant" updatable="true">{$temp.tmp_SapCredentials[1]/hostname}/sap/opu/odata/sap/API_OPLACCTGDOCITEMCUBE_SRV/A_OperationalAcctgDocItemCube</parameter>
                           <parameter name="i_RequestPayload" source="constant" updatable="true">NA</parameter>
                           <parameter name="i_HelpFileLInk" source="constant" updatable="true">NA</parameter>
                           <parameter name="i_ProcessStartTime" source="field" updatable="true">input.in_ParentProcess_StartTime</parameter>
                        </input>
                        <outputDef/>
                        <link id="lfb330rt" targetId="lfb330rr"/>
                     </subflow>
                     <jumpTo id="lfb330rr">
                        <link id="lfb330rs" targetId="lfayk0tk"/>
                     </jumpTo>
                  </flow>
                  <link id="lfb32y7p" targetId="lfb32y7q" type="containerLink"/>
                  <link id="lfayk02o" targetId="lfayk02n"/>
                  <events>
                     <catch faultField="BS_faultInfo" id="lfb32y7n" interrupting="true">
                        <link id="lfb32y7s" targetId="lfb32y7t" type="containerLink"/>
                     </catch>
                  </events>
               </eventContainer>
               <container id="lfayk0j8" type="exclusive">
                  <title>Results count</title>
                  <flow id="lfayk0j9">
                     <assignment id="lfayk0ja">
                        <title>Set Multiple BS Records Failure</title>
                        <operation source="constant" to="temp.tmp_IICS_Status">Failed</operation>
                        <operation source="constant" to="temp.tmp_FailureReason">Multiple bank entries found in S4</operation>
                        <operation source="constant" to="temp.tmp_FailedAtStep">Fetch Bank Statement from S4</operation>
                        <link id="lfayk0kl" targetId="lfayk0jb"/>
                     </assignment>
                     <subflow id="lfayk0jb">
                        <title>Log Fetch Bank Statement Error</title>
                        <subflowGUID>7N5uKhvv6kXg3zoRAbuggF</subflowGUID>
                        <subflowPath>Process_P2B_Event_ErrorLog</subflowPath>
                        <runForEach>false</runForEach>
                        <input>
                           <parameter name="i_X_TRANSACTION_ID" source="constant" updatable="true">{$input.in_X_TRANSACTION_ID}</parameter>
                           <parameter name="i_IICS_Run_ID" source="field" updatable="true">temp.tmp_IICS_Process_ID</parameter>
                           <parameter name="i_Code" source="constant" updatable="true">HTTP_404</parameter>
                           <parameter name="i_Error" source="constant" updatable="true">{$temp.tmp_FailureReason}</parameter>
                           <parameter name="i_Description" source="constant" updatable="true">{$temp.tmp_S4Bank_Count} bank statement entries found in S4</parameter>
                           <parameter name="i_APIName" source="constant" updatable="true">{$input.in_ApiName}</parameter>
                           <parameter name="i_EventName" source="constant" updatable="true">{$input.in_EventName}</parameter>
                           <parameter name="i_DataKey" source="constant" updatable="true">{$input.in_DataKey}</parameter>
                           <parameter name="i_IICSProcessname" source="formula" updatable="true">
                              <expression language="XQuery">util:getAssetName()</expression>
                           </parameter>
                           <parameter name="i_FailedAtStep" source="constant" updatable="true">{$temp.tmp_FailedAtStep}</parameter>
                           <parameter name="i_RestURL" source="constant" updatable="true">{$temp.tmp_SapCredentials[1]/hostname}/sap/opu/odata/sap/API_OPLACCTGDOCITEMCUBE_SRV/A_OperationalAcctgDocItemCube</parameter>
                           <parameter name="i_RequestPayload" source="constant" updatable="true">NA</parameter>
                           <parameter name="i_HelpFileLInk" source="constant" updatable="true">NA</parameter>
                           <parameter name="i_ProcessStartTime" source="field" updatable="true">input.in_ParentProcess_StartTime</parameter>
                        </input>
                        <outputDef/>
                        <link id="lfayk0km" targetId="lfayk0jc"/>
                     </subflow>
                     <jumpTo id="lfayk0jc">
                        <link id="lfayk0kn" targetId="lfayk0tk"/>
                     </jumpTo>
                  </flow>
                  <flow id="lfayk0jd">
                     <assignment id="lfayk0je">
                        <title>Set No BS Records Failure</title>
                        <operation source="constant" to="temp.tmp_IICS_Status">Failed</operation>
                        <operation source="constant" to="temp.tmp_FailedAtStep">Fetch Bank Statement from S4</operation>
                        <operation source="constant" to="temp.tmp_FailureReason">No bank entries found in S4</operation>
                        <link id="lfayk0ko" targetId="lfayk0jf"/>
                     </assignment>
                     <subflow id="lfayk0jf">
                        <title>Log Bank Statement Error</title>
                        <subflowGUID>7N5uKhvv6kXg3zoRAbuggF</subflowGUID>
                        <subflowPath>Process_P2B_Event_ErrorLog</subflowPath>
                        <runForEach>false</runForEach>
                        <input>
                           <parameter name="i_X_TRANSACTION_ID" source="constant" updatable="true">{$input.in_X_TRANSACTION_ID}</parameter>
                           <parameter name="i_IICS_Run_ID" source="field" updatable="true">temp.tmp_IICS_Process_ID</parameter>
                           <parameter name="i_Code" source="constant" updatable="true">HTTP_404</parameter>
                           <parameter name="i_Error" source="constant" updatable="true">{$temp.tmp_FailureReason}</parameter>
                           <parameter name="i_Description" source="constant" updatable="true">0 bank statement entries found in S4</parameter>
                           <parameter name="i_APIName" source="constant" updatable="true">{$input.in_ApiName}</parameter>
                           <parameter name="i_EventName" source="constant" updatable="true">{$input.in_EventName}</parameter>
                           <parameter name="i_DataKey" source="constant" updatable="true">{$input.in_DataKey}</parameter>
                           <parameter name="i_IICSProcessname" source="formula" updatable="true">
                              <expression language="XQuery">util:getAssetName()</expression>
                           </parameter>
                           <parameter name="i_FailedAtStep" source="constant" updatable="true">{$temp.tmp_FailedAtStep}</parameter>
                           <parameter name="i_RestURL" source="constant" updatable="true">{$temp.tmp_SapCredentials[1]/hostname}/sap/opu/odata/sap/API_OPLACCTGDOCITEMCUBE_SRV/A_OperationalAcctgDocItemCube</parameter>
                           <parameter name="i_RequestPayload" source="constant" updatable="true">NA</parameter>
                           <parameter name="i_HelpFileLInk" source="constant" updatable="true">NA</parameter>
                           <parameter name="i_ProcessStartTime" source="field" updatable="true">input.in_ParentProcess_StartTime</parameter>
                        </input>
                        <outputDef/>
                        <link id="lfayk0kp" targetId="lfayk0jg"/>
                     </subflow>
                     <jumpTo id="lfayk0jg">
                        <link id="lfayk0kq" targetId="lfayk0tk"/>
                     </jumpTo>
                  </flow>
                  <flow id="lfayk0jh">
                     <container id="lfayk0ji" type="exclusive">
                        <title>Previous Failure for B1Ref</title>
                        <flow id="lfayk0jj">
                           <assignment id="lfayk0jk">
                              <title>Get FailedAtStep</title>
                              <operation source="field" to="temp.tmp_PreviousFailure_Status">temp.tmp_VIP_FailedLog_Record.IICS_Status</operation>
                              <operation source="field" to="temp.tmp_PreviousFailure_FailedAtStep">temp.tmp_VIP_FailedLog_Record.IICS_FailedAtStep</operation>
                              <operation source="formula" to="temp.tmp_FailedAtStep_Reason">
                                 <expression language="XQuery">util:iif($temp.tmp_PreviousFailure_Status = 'Failed' and ($temp.tmp_PreviousFailure_FailedAtStep = 'Post Journal clearing to S4' or $temp.tmp_PreviousFailure_FailedAtStep = 'SAP S4 : Failed to clear Journal Entry' or $temp.tmp_PreviousFailure_FailedAtStep = 'SAP S4 : Journal clearing response not received' or fn:contains($temp.tmp_PreviousFailure_FailedAtStep , 'clear')), 'Clearing', 'JournalPosting')</expression>
                              </operation>
                              <link id="lfayk0kw" targetId="lfayk0jl"/>
                           </assignment>
                           <container id="lfayk0jl" type="exclusive">
                              <title>Previous Failure Reason</title>
                              <flow id="lfayk0jm">
                                 <link id="lfayk0kz" targetId="lfayk0jl" type="containerLink"/>
                              </flow>
                              <flow id="lfayk0jn">
                                 <service id="lfayk0jo">
                                    <title>Fetch AccountingDocument from S4 Bank Statement</title>
                                    <serviceName>AppsvcSapS4-AccountingDocumentRead-Custom:GET_A_AccountingDocEntry</serviceName>
                                    <serviceGUID>3VZyEkGkNjxcf47SnZiTww</serviceGUID>
                                    <serviceInput>
                                       <parameter name="hostname" source="field" updatable="true">temp.tmp_SapCredentials[1]/hostname</parameter>
                                       <parameter name="username" source="field" updatable="true">temp.tmp_SapCredentials[1]/username</parameter>
                                       <parameter name="password" source="field" updatable="true">temp.tmp_SapCredentials[1]/password</parameter>
                                       <parameter name="CompanyCode" source="field" updatable="true">input.in_Payload[1]/CompanyCode</parameter>
                                       <parameter name="BankRef" source="field" updatable="true">input.in_Payload[1]/BankRef</parameter>
                                       <parameter name="Ref_ID" source="field" updatable="true">input.in_Payload[1]/B1_Ref_ID</parameter>
                                       <parameter name="AmountInTransactionCurrency" source="formula">
                                          <expression language="XQuery">fn:format-number($input.in_Payload[1]/AmountReceived, '#0.##')</expression>
                                       </parameter>
                                       <parameter name="PostingDate" source="formula">
                                          <expression language="XQuery">fn:replace($input.in_Payload[1]/PostDate, 'Z', '.000')</expression>
                                       </parameter>
                                       <parameter name="AccountingDocCreatedByUser" source="field" updatable="true">temp.tmp_CreatedBy</parameter>
                                       <parameter name="Reference2InDocumentHeader" source="field" updatable="true">temp.tmp_Reference2</parameter>
                                       <parameter name="GLAccount" source="field" updatable="true">input.in_Payload[1]/GL_CashReceipt_S4</parameter>
                                    </serviceInput>
                                    <link id="lfayk0l0" targetId="lfayk0jp"/>
                                 </service>
                                 <assignment id="lfayk0jp">
                                    <title>Set Journal Fetch Status</title>
                                    <operation source="formula" to="temp.tmp_JournalFetch_Status">
                                       <expression language="XQuery">util:iif(util:isNull($output.AccountingDocument ) or $output.AccountingDocument='' or fn:string-length($output.AccountingDocument)=0, 'N', 'Y')</expression>
                                    </operation>
                                    <link id="lfayk0l1" targetId="lfayk0jq"/>
                                 </assignment>
                                 <container id="lfayk0jq" type="exclusive">
                                    <title>Journal Fetched</title>
                                    <flow id="lfayk0jr">
                                       <link id="lfayk0l5" targetId="lfayk0jq" type="containerLink"/>
                                    </flow>
                                    <flow id="lfayk0js">
                                       <assignment id="lfayk0jt">
                                          <title>Set Journal Fetch Failure</title>
                                          <operation source="constant" to="temp.tmp_IICS_Status">Failed</operation>
                                          <operation source="constant" to="temp.tmp_FailedAtStep">Fetch Journal entry created on previous run from S4</operation>
                                          <operation source="constant" to="temp.tmp_FailureReason">Failed to fetch Journal entry created on previous run from S4</operation>
                                          <link id="lfayk0l6" targetId="lfayk0ju"/>
                                       </assignment>
                                       <subflow id="lfayk0ju">
                                          <title>Log Journal Fetch Error</title>
                                          <subflowGUID>7N5uKhvv6kXg3zoRAbuggF</subflowGUID>
                                          <subflowPath>Process_P2B_Event_ErrorLog</subflowPath>
                                          <runForEach>false</runForEach>
                                          <input>
                                             <parameter name="i_X_TRANSACTION_ID" source="constant" updatable="true">{$input.in_X_TRANSACTION_ID}</parameter>
                                             <parameter name="i_IICS_Run_ID" source="field" updatable="true">temp.tmp_IICS_Process_ID</parameter>
                                             <parameter name="i_Code" source="constant" updatable="true">HTTP_404</parameter>
                                             <parameter name="i_Error" source="constant" updatable="true">{$temp.tmp_FailureReason}</parameter>
                                             <parameter name="i_Description" source="constant" updatable="true">{$temp.tmp_FailureReason}</parameter>
                                             <parameter name="i_APIName" source="constant" updatable="true">{$input.in_ApiName}</parameter>
                                             <parameter name="i_EventName" source="constant" updatable="true">{$input.in_EventName}</parameter>
                                             <parameter name="i_DataKey" source="constant" updatable="true">{$input.in_DataKey}</parameter>
                                             <parameter name="i_IICSProcessname" source="formula" updatable="true">
                                                <expression language="XQuery">util:getAssetName()</expression>
                                             </parameter>
                                             <parameter name="i_FailedAtStep" source="constant" updatable="true">{$temp.tmp_FailedAtStep}</parameter>
                                             <parameter name="i_RestURL" source="constant" updatable="true">{$temp.tmp_SapCredentials[1]/hostname}/sap/opu/odata/sap/API_OPLACCTGDOCITEMCUBE_SRV/A_OperationalAcctgDocItemCube</parameter>
                                             <parameter name="i_RequestPayload" source="constant" updatable="true">NA</parameter>
                                             <parameter name="i_HelpFileLInk" source="constant" updatable="true">NA</parameter>
                                             <parameter name="i_ProcessStartTime" source="field" updatable="true">input.in_ParentProcess_StartTime</parameter>
                                          </input>
                                          <outputDef/>
                                          <link id="lfayk0l7" targetId="lfayk0jv"/>
                                       </subflow>
                                       <jumpTo id="lfayk0jv">
                                          <link id="lfayk0l8" targetId="lfayk0tk"/>
                                       </jumpTo>
                                    </flow>
                                    <link id="lfayk0l2" targetId="lfayk0jr" type="containerLink">
                                       <condition source="formula">
                                          <function name="string-equals">
                                             <arg name="left">{$temp.tmp_JournalFetch_Status}</arg>
                                             <arg name="right">Y</arg>
                                          </function>
                                       </condition>
                                    </link>
                                    <link id="lfayk0l3" targetId="lfayk0js" type="containerLink"/>
                                    <link id="lfayk0l4" targetId="lfayk0jw"/>
                                 </container>
                                 <jumpTo id="lfayk0jw">
                                    <link id="lfayk0l9" targetId="lfayk0jz"/>
                                 </jumpTo>
                              </flow>
                              <link id="lfayk0kx" targetId="lfayk0jm" type="containerLink">
                                 <condition source="formula">
                                    <function name="string-equals">
                                       <arg name="left">{$temp.tmp_FailedAtStep_Reason}</arg>
                                       <arg name="right">JournalPosting</arg>
                                    </function>
                                 </condition>
                              </link>
                              <link id="lfayk0ky" targetId="lfayk0jn" type="containerLink"/>
                           </container>
                           <link id="lfayk0kv" targetId="lfayk0ji" type="containerLink"/>
                        </flow>
                        <flow id="lfayk0jx">
                           <link id="lfayk0la" targetId="lfayk0ji" type="containerLink"/>
                        </flow>
                        <link id="lfayk0ks" targetId="lfayk0jj" type="containerLink">
                           <condition source="formula">
                              <function name="set">
                                 <arg name="field">{$temp.tmp_VIP_FailedLog_Record}</arg>
                              </function>
                           </condition>
                        </link>
                        <link id="lfayk0ku" targetId="lfayk0jx" type="containerLink">
                           <condition source="formula">
                              <function name="unset">
                                 <arg name="field">{$temp.tmp_VIP_FailedLog_Record}</arg>
                              </function>
                           </condition>
                        </link>
                        <link id="lfayk0u1" targetId="lfayk0t9"/>
                     </container>
                     <container id="lfayk0k7" type="exclusive">
                        <title>Response Code</title>
                        <flow id="lfayk0k8">
                           <assignment id="lfayk0k9">
                              <title>Set Success Details</title>
                              <operation source="constant" to="temp.tmp_IICS_Status">Success</operation>
                              <operation source="constant" to="temp.tmp_FailedAtStep">N/A</operation>
                              <operation source="constant" to="temp.tmp_FailureReason">N/A</operation>
                              <link id="lfayk0ln" targetId="lfayk0ka"/>
                           </assignment>
                           <container id="lfayk0ka" type="exclusive">
                              <title>Previous Failure Record</title>
                              <flow id="lfayk0kb">
                                 <create id="lfayk0kc">
                                    <title>Insert Success entry into FailureLog</title>
                                    <entityName>AppConnVIPIntegrations-CF:api_20_Failure_Log</entityName>
                                    <createInput>
                                       <parameter name="B1_Ref_ID" source="field" updatable="true">input.in_Payload[1]/B1_Ref_ID</parameter>
                                       <parameter name="BankRef" source="field" updatable="true">input.in_Payload[1]/BankRef</parameter>
                                       <parameter name="BankAccount" source="field" updatable="true">input.in_Payload[1]/BankAccount</parameter>
                                       <parameter name="GL_CashReceipt_B1" source="field" updatable="true">input.in_Payload[1]/GL_CashReceipt_B1</parameter>
                                       <parameter name="GL_ControlAccount_B1" source="field" updatable="true">input.in_Payload[1]/GL_Target_B1</parameter>
                                       <parameter name="GL_CashReceipt_S4" source="field" updatable="true">input.in_Payload[1]/GL_CashReceipt_S4</parameter>
                                       <parameter name="GL_ControlAccount_S4" source="field" updatable="true">input.in_Payload[1]/GL_Target_S4</parameter>
                                       <parameter name="BankCurrrency" source="field" updatable="true">input.in_Payload[1]/BankCurrency</parameter>
                                       <parameter name="Rece_Amount" source="field" updatable="true">input.in_Payload[1]/AmountReceived</parameter>
                                       <parameter name="PostDate" source="field" updatable="true">input.in_Payload[1]/PostDate</parameter>
                                       <parameter name="ValueDate" source="field" updatable="true">input.in_Payload[1]/ValueDate</parameter>
                                       <parameter name="CompanyCode" source="field" updatable="true">input.in_Payload[1]/CompanyCode</parameter>
                                       <parameter name="Document_Item_Text" source="field" updatable="true">input.in_Payload[1]/DocumentItemText</parameter>
                                       <parameter name="IICS_Status" source="constant" updatable="true">Success</parameter>
                                       <parameter name="IICS_Message" source="constant" updatable="true">Successfully cleared</parameter>
                                       <parameter name="IICS_FailedAtStep" source="constant" updatable="true">N/A</parameter>
                                       <parameter name="DateCreated" source="field" updatable="true">input.in_ParentProcess_StartTime</parameter>
                                    </createInput>
                                 </create>
                                 <link id="lfayk0lr" targetId="lfayk0ka" type="containerLink"/>
                              </flow>
                              <flow id="lfayk0kd">
                                 <link id="lfayk0ls" targetId="lfayk0ka" type="containerLink"/>
                              </flow>
                              <link id="lfayk0lo" targetId="lfayk0kb" type="containerLink">
                                 <condition source="formula">
                                    <function name="set">
                                       <arg name="field">{$temp.tmp_VIP_FailedLog_Record}</arg>
                                    </function>
                                 </condition>
                              </link>
                              <link id="lfayk0lp" targetId="lfayk0kd" type="containerLink">
                                 <condition source="formula">
                                    <function name="unset">
                                       <arg name="field">{$temp.tmp_VIP_FailedLog_Record}</arg>
                                    </function>
                                 </condition>
                              </link>
                              <link id="lfayk0lq" targetId="lfayk0ke"/>
                           </container>
                           <subflow id="lfayk0ke">
                              <title>Update TransactionLog records</title>
                              <subflowGUID>3VuWJBCBkS5iXkA0HAf3eA</subflowGUID>
                              <subflowPath>Process_DELETE_or_UPDATE_api_20_Transaction_Log</subflowPath>
                              <runForEach>false</runForEach>
                              <input>
                                 <parameter name="in_B1_Ref" source="field" updatable="true">input.in_Payload[1]/B1_Ref_ID</parameter>
                                 <parameter name="in_Status" source="constant" updatable="true">Success</parameter>
                                 <parameter name="in_IICS_Message" source="constant" updatable="true">Successfully cleared</parameter>
                                 <parameter name="in_CreatedDate" source="field" updatable="true">input.in_ParentProcess_StartTime</parameter>
                              </input>
                              <outputDef/>
                              <link id="lfayk0yc" targetId="lfayk0yb"/>
                           </subflow>
                           <end id="lfayk0yb">
                              <title>End 2</title>
                           </end>
                        </flow>
                        <flow id="lfayk0kf">
                           <assignment id="lfayk0kg">
                              <title>Set Clearance Failure Details</title>
                              <operation source="constant" to="temp.tmp_IICS_Status">Failed</operation>
                              <operation source="formula" to="temp.tmp_FailureReason">
                                 <expression language="XQuery">$output.out_PostClearingResponseMessage||' -- '||$output.out_PostClearingResponseDetails

</expression>
                              </operation>
                              <operation source="constant" to="temp.tmp_FailedAtStep">Post Journal clearing to S4</operation>
                              <link id="lfayk0lt" targetId="lfayk0kh"/>
                           </assignment>
                           <jumpTo id="lfayk0kh">
                              <link id="lfayk0lu" targetId="lfayk0tk"/>
                           </jumpTo>
                        </flow>
                        <link id="lfayk0lk" targetId="lfayk0k8" type="containerLink">
                           <condition source="formula">
                              <function name="starts-with">
                                 <arg name="left">{$output.out_PostClearingResponseCode}</arg>
                                 <arg name="right">1</arg>
                              </function>
                           </condition>
                        </link>
                        <link id="lfayk0ll" targetId="lfayk0kf" type="containerLink"/>
                     </container>
                     <eventContainer id="lfayk0t9">
                        <subflow id="lfayk0tn">
                           <title>Post Matched Items to S4</title>
                           <subflowGUID>2GoHM40fVmKjlTZ5291uoI</subflowGUID>
                           <subflowPath>Process_POST_JournalEntryBulkCreateRequest</subflowPath>
                           <runForEach>false</runForEach>
                           <input>
                              <parameter name="in_JournalEntryCreateRequest" source="field" updatable="true">temp.tmp_JournalEntryCreateRequest</parameter>
                              <parameter name="in_Transaction_ID" source="field" updatable="true">input.in_X_TRANSACTION_ID</parameter>
                              <parameter name="in_IICS_Run_ID" source="field" updatable="true">temp.tmp_IICS_Process_ID</parameter>
                              <parameter name="in_Event_Name" source="field" updatable="true">input.in_EventName</parameter>
                              <parameter name="in_API_Name" source="field" updatable="true">input.in_ApiName</parameter>
                              <parameter name="in_ProformaNr" source="field" updatable="true">input.in_DataKey</parameter>
                              <parameter name="in_ParentProcessStartTime" source="field" updatable="true">input.in_ParentProcess_StartTime</parameter>
                           </input>
                           <outputDef>
                              <field name="out_JournalConfirmation_Payload" type="reference">
                                 <options>
                                    <option name="referenceTo">$po:$any</option>
                                    <option name="required">false</option>
                                    <option name="isCopy">true</option>
                                 </options>
                              </field>
                              <field name="out_ResponseCode" type="string">
                                 <options>
                                    <option name="required">false</option>
                                 </options>
                              </field>
                           </outputDef>
                        </subflow>
                        <flow id="lfayk0ta">
                           <assignment id="lfayk0tb">
                              <title>Collect Output</title>
                              <operation source="formula" to="temp.tmp_MatchingItemsFeedback">
                                 <expression language="XQuery">$output.out_JournalConfirmation_Payload</expression>
                              </operation>
                              <operation source="formula" to="temp.tmp_JournalPosting_Status">
                                 <expression language="XQuery">util:iif(fn:starts-with($output.out_ResponseCode , '4') or fn:starts-with($output.out_ResponseCode , 'HTTP_4') or $output.out_ResponseCode = '3' or list:count($output.out_JournalConfirmation_Payload)=0 or $temp.tmp_MatchingItemsFeedback[1]/JournalEntryCreateConfirmation[1]/Log[1]/MaximumLogItemSeverityCode = '3', 'Fail', 'Success')</expression>
                              </operation>
                              <link id="lfayk0tr" targetId="lfayk0tc"/>
                           </assignment>
                           <container id="lfayk0tc" type="exclusive">
                              <title>Journal Posing Status</title>
                              <flow id="lfayk0td">
                                 <assignment id="lfayk0te">
                                    <title>Set Journal Posting Failure Details</title>
                                    <operation source="constant" to="temp.tmp_IICS_Status">Failed</operation>
                                    <operation source="formula" to="temp.tmp_FailureReason">
                                       <expression language="XQuery"> util:iif(list:count($temp.tmp_MatchingItemsFeedback) &gt; 0, (for $itm in $temp.tmp_MatchingItemsFeedback[1]/JournalEntryCreateConfirmation[1]/Log/*:Item 
 return 
 fn:concat(fn:string-join($itm/Note/text(), "+"), "; ")),$output.out_ResponseCode )</expression>
                                    </operation>
                                    <operation source="constant" to="temp.tmp_FailedAtStep">Post Matched Items to S4</operation>
                                    <link id="lfayk0tu" targetId="lfayk0tf"/>
                                 </assignment>
                                 <jumpTo id="lfayk0tf">
                                    <link id="lfayk0tv" targetId="lfayk0tk"/>
                                 </jumpTo>
                              </flow>
                              <flow id="lfayk0tg">
                                 <link id="lfayk0tw" targetId="lfayk0tc" type="containerLink"/>
                              </flow>
                              <link id="lfayk0ts" targetId="lfayk0td" type="containerLink">
                                 <condition source="formula">
                                    <function name="string-equals">
                                       <arg name="left">{$temp.tmp_JournalPosting_Status}</arg>
                                       <arg name="right">Fail</arg>
                                    </function>
                                 </condition>
                              </link>
                              <link id="lfayk0tt" targetId="lfayk0tg" type="containerLink"/>
                           </container>
                           <link id="lfayk0tq" targetId="lfayk0t9" type="containerLink"/>
                        </flow>
                        <flow id="lfayk0th">
                           <assignment id="lfayk0ti">
                              <title>Set JournalPosting Failure Details</title>
                              <operation source="constant" to="temp.tmp_IICS_Status">Failed</operation>
                              <operation source="formula" to="temp.tmp_FailureReason">
                                 <expression language="XQuery">$output.faultInfo[1]/Reason||'; '||$output.faultInfo[1]/Details</expression>
                              </operation>
                              <operation source="constant" to="temp.tmp_FailedAtStep">Post Matched Items to S4</operation>
                              <link id="lfayk0tx" targetId="lfayk0tj"/>
                           </assignment>
                           <subflow id="lfayk0tj">
                              <title>Log Error</title>
                              <subflowGUID>7N5uKhvv6kXg3zoRAbuggF</subflowGUID>
                              <subflowPath>Process_P2B_Event_ErrorLog</subflowPath>
                              <runForEach>false</runForEach>
                              <input>
                                 <parameter name="i_X_TRANSACTION_ID" source="constant" updatable="true">{$input.in_X_TRANSACTION_ID}</parameter>
                                 <parameter name="i_IICS_Run_ID" source="field" updatable="true">temp.tmp_IICS_Process_ID</parameter>
                                 <parameter name="i_Code" source="field" updatable="true">output.faultInfo[1]/code</parameter>
                                 <parameter name="i_Error" source="field" updatable="true">output.faultInfo[1]/reason</parameter>
                                 <parameter name="i_Description" source="field" updatable="true">output.faultInfo[1]/detail</parameter>
                                 <parameter name="i_APIName" source="constant" updatable="true">{$input.in_ApiName}</parameter>
                                 <parameter name="i_EventName" source="constant" updatable="true">{$input.in_EventName}</parameter>
                                 <parameter name="i_DataKey" source="constant" updatable="true">{$input.in_DataKey}</parameter>
                                 <parameter name="i_IICSProcessname" source="formula" updatable="true">
                                    <expression language="XQuery">util:getAssetName()</expression>
                                 </parameter>
                                 <parameter name="i_FailedAtStep" source="constant" updatable="true">{$temp.tmp_FailedAtStep} - Uncaught error from Process_POST_JournalEntryBulkCreateRequest</parameter>
                                 <parameter name="i_RestURL" source="constant" updatable="true">NA</parameter>
                                 <parameter name="i_RequestPayload" source="constant" updatable="true">NA</parameter>
                                 <parameter name="i_HelpFileLInk" source="constant" updatable="true">NA</parameter>
                                 <parameter name="i_ProcessStartTime" source="field" updatable="true">input.in_ParentProcess_StartTime</parameter>
                              </input>
                              <outputDef/>
                              <link id="lfayk0ty" targetId="lfayk0tk"/>
                           </subflow>
                           <subflow id="lfayk0tk">
                              <title>Delete TransactionLog records</title>
                              <subflowGUID>3VuWJBCBkS5iXkA0HAf3eA</subflowGUID>
                              <subflowPath>Process_DELETE_or_UPDATE_api_20_Transaction_Log</subflowPath>
                              <runForEach>false</runForEach>
                              <input>
                                 <parameter name="in_B1_Ref" source="field" updatable="true">input.in_Payload[1]/B1_Ref_ID</parameter>
                                 <parameter name="in_Status" source="constant" updatable="true">Failed</parameter>
                                 <parameter name="in_IICS_Message" source="field" updatable="true">temp.tmp_FailureReason</parameter>
                                 <parameter name="in_CreatedDate" source="field" updatable="true">input.in_ParentProcess_StartTime</parameter>
                              </input>
                              <outputDef/>
                              <link id="lfayk0tz" targetId="lfayk0tl"/>
                           </subflow>
                           <create id="lfayk0tl">
                              <title>Insert Failure Log entry</title>
                              <entityName>AppConnVIPIntegrations-CF:api_20_Failure_Log</entityName>
                              <createInput>
                                 <parameter name="B1_Ref_ID" source="field" updatable="true">input.in_Payload[1]/B1_Ref_ID</parameter>
                                 <parameter name="BankRef" source="field" updatable="true">input.in_Payload[1]/BankRef</parameter>
                                 <parameter name="BankAccount" source="field" updatable="true">input.in_Payload[1]/BankAccount</parameter>
                                 <parameter name="GL_CashReceipt_B1" source="field" updatable="true">input.in_Payload[1]/GL_CashReceipt_B1</parameter>
                                 <parameter name="GL_ControlAccount_B1" source="field" updatable="true">input.in_Payload[1]/GL_Target_B1</parameter>
                                 <parameter name="GL_CashReceipt_S4" source="field" updatable="true">input.in_Payload[1]/GL_CashReceipt_S4</parameter>
                                 <parameter name="GL_ControlAccount_S4" source="field" updatable="true">input.in_Payload[1]/GL_Target_S4</parameter>
                                 <parameter name="BankCurrrency" source="field" updatable="true">input.in_Payload[1]/BankCurrency</parameter>
                                 <parameter name="Rece_Amount" source="field" updatable="true">input.in_Payload[1]/AmountReceived</parameter>
                                 <parameter name="PostDate" source="field" updatable="true">input.in_Payload[1]/PostDate</parameter>
                                 <parameter name="ValueDate" source="field" updatable="true">input.in_Payload[1]/ValueDate</parameter>
                                 <parameter name="CompanyCode" source="field" updatable="true">input.in_Payload[1]/CompanyCode</parameter>
                                 <parameter name="Document_Item_Text" source="field" updatable="true">input.in_Payload[1]/DocumentItemText</parameter>
                                 <parameter name="IICS_Status" source="constant" updatable="true">Failed</parameter>
                                 <parameter name="IICS_Message" source="field" updatable="true">temp.tmp_FailureReason</parameter>
                                 <parameter name="IICS_FailedAtStep" source="field" updatable="true">temp.tmp_FailedAtStep</parameter>
                                 <parameter name="IICS_FailureDate" source="formula" updatable="true">
                                    <expression language="XQuery">fn:current-dateTime()</expression>
                                 </parameter>
                                 <parameter name="DateCreated" source="field" updatable="true">input.in_ParentProcess_StartTime</parameter>
                              </createInput>
                              <link id="lfayk0u0" targetId="lfayk0tm"/>
                           </create>
                           <end id="lfayk0tm">
                              <title>End 1</title>
                           </end>
                        </flow>
                        <link id="lfayk0to" targetId="lfayk0ta" type="containerLink"/>
                        <link id="lfayk0u2" targetId="lfayk0jz"/>
                        <events>
                           <catch faultField="faultInfo" id="lb0ft695" interrupting="true">
                              <link id="lfayk0tp" targetId="lfayk0th" type="containerLink"/>
                           </catch>
                        </events>
                     </eventContainer>
                     <eventContainer id="lfayk0k0">
                        <subflow id="lfayk0k6">
                           <title>Clear Payment in S4</title>
                           <subflowGUID>4YB8TOT7lQDiN415WJIl4j</subflowGUID>
                           <subflowPath>Process_POST_JournalEntryBulkClearingRequest</subflowPath>
                           <runForEach>false</runForEach>
                           <input>
                              <parameter name="in_JournalEntryClearingRequest"
                                         source="field"
                                         updatable="true">temp.tmp_JournalEntryClearingRequest</parameter>
                              <parameter name="in_Transaction_ID" source="field" updatable="true">input.in_X_TRANSACTION_ID</parameter>
                              <parameter name="in_IICS_Run_ID" source="field" updatable="true">temp.tmp_IICS_Process_ID</parameter>
                              <parameter name="in_Event_Name" source="field" updatable="true">input.in_EventName</parameter>
                              <parameter name="in_API_Name" source="field" updatable="true">input.in_ApiName</parameter>
                              <parameter name="in_ProformaNr" source="field" updatable="true">input.in_DataKey</parameter>
                              <parameter name="in_ParentProcessStartTime" source="field" updatable="true">input.in_ParentProcess_StartTime</parameter>
                              <parameter name="in_MessageID" source="field" updatable="true">temp.tmp_MessageID</parameter>
                              <parameter name="in_DataKey" source="field" updatable="true">input.in_DataKey</parameter>
                           </input>
                           <outputDef>
                              <field name="out_PostClearingResponseCode" type="string">
                                 <options>
                                    <option name="required">false</option>
                                 </options>
                              </field>
                              <field name="out_PostClearingResponseMessage" type="string">
                                 <options>
                                    <option name="required">false</option>
                                 </options>
                              </field>
                              <field name="out_PostClearingResponseDetails" type="string">
                                 <options>
                                    <option name="required">false</option>
                                 </options>
                              </field>
                           </outputDef>
                        </subflow>
                        <flow id="lfayk0k1">
                           <link id="lfayk0lg" targetId="lfayk0k0" type="containerLink"/>
                        </flow>
                        <flow id="lfayk0k2">
                           <assignment id="lfayk0k3">
                              <title>Set ClearancePosting Failure</title>
                              <operation source="constant" to="temp.tmp_IICS_Status">Failed</operation>
                              <operation source="formula" to="temp.tmp_FailureReason">
                                 <expression language="XQuery">$output.CP_faultInfo[1]/reason ||'; '||$output.CP_faultInfo[1]/detail </expression>
                              </operation>
                              <operation source="constant" to="temp.tmp_FailedAtStep">Post Journal clearing to S4</operation>
                              <link id="lfayk0lh" targetId="lfayk0k4"/>
                           </assignment>
                           <subflow id="lfayk0k4">
                              <title>Log Clearance Posting Error</title>
                              <subflowGUID>7N5uKhvv6kXg3zoRAbuggF</subflowGUID>
                              <subflowPath>Process_P2B_Event_ErrorLog</subflowPath>
                              <runForEach>false</runForEach>
                              <input>
                                 <parameter name="i_X_TRANSACTION_ID" source="constant" updatable="true">{$input.in_X_TRANSACTION_ID}</parameter>
                                 <parameter name="i_IICS_Run_ID" source="field" updatable="true">temp.tmp_IICS_Process_ID</parameter>
                                 <parameter name="i_Code" source="field" updatable="true">output.CP_faultInfo[1]/code</parameter>
                                 <parameter name="i_Error" source="field" updatable="true">output.CP_faultInfo[1]/reason</parameter>
                                 <parameter name="i_Description" source="field" updatable="true">output.CP_faultInfo[1]/detail</parameter>
                                 <parameter name="i_APIName" source="constant" updatable="true">{$input.in_ApiName}</parameter>
                                 <parameter name="i_EventName" source="constant" updatable="true">{$input.in_EventName}</parameter>
                                 <parameter name="i_DataKey" source="constant" updatable="true">{$input.in_DataKey}</parameter>
                                 <parameter name="i_IICSProcessname" source="formula" updatable="true">
                                    <expression language="XQuery">util:getAssetName()</expression>
                                 </parameter>
                                 <parameter name="i_FailedAtStep" source="constant" updatable="true">{$temp.tmp_FailedAtStep} - Uncaught error from Process_POST_JournalEntryBulkClearingRequest</parameter>
                                 <parameter name="i_RestURL" source="constant" updatable="true">NA</parameter>
                                 <parameter name="i_RequestPayload" source="constant" updatable="true">NA</parameter>
                                 <parameter name="i_HelpFileLInk" source="constant" updatable="true">NA</parameter>
                                 <parameter name="i_ProcessStartTime" source="field" updatable="true">input.in_ParentProcess_StartTime</parameter>
                              </input>
                              <outputDef/>
                              <link id="lfayk0li" targetId="lfayk0k5"/>
                           </subflow>
                           <jumpTo id="lfayk0k5">
                              <link id="lfayk0lj" targetId="lfayk0tk"/>
                           </jumpTo>
                        </flow>
                        <link id="lfayk0ld" targetId="lfayk0k1" type="containerLink"/>
                        <link id="lfayk0lf" targetId="lfayk0k7"/>
                        <events>
                           <catch faultField="CP_faultInfo" id="le59ipl6" interrupting="true">
                              <link id="lfayk0le" targetId="lfayk0k2" type="containerLink"/>
                           </catch>
                        </events>
                     </eventContainer>
                     <assignment id="lfayk0jz">
                        <title>Prepare S4 Payload for Journal Clearing</title>
                        <operation source="formula" to="temp.tmp_JournalEntryClearingRequest">
                           <expression language="XQuery">&lt;soapenv:Envelope xmlns:soapenv="http://schemas.xmlsoap.org/soap/envelope/" xmlns:sfin="http://sap.com/xi/SAPSCORE/SFIN"&gt;
    &lt;soapenv:Header/&gt;
    &lt;soapenv:Body&gt;
        &lt;sfin:JournalEntryBulkClearingRequest&gt;
            &lt;MessageHeader&gt;                
                &lt;ID&gt;{$temp.tmp_MessageID/text()}&lt;/ID&gt;
                &lt;CreationDateTime&gt;{fn:current-dateTime()}&lt;/CreationDateTime&gt;
				&lt;SenderBusinessSystemID&gt;VIP&lt;/SenderBusinessSystemID&gt;
                &lt;TestDataIndicator&gt;false&lt;/TestDataIndicator&gt;   
            &lt;/MessageHeader&gt;
			
            &lt;JournalEntryClearingRequest&gt;
                &lt;MessageHeader&gt;
                    &lt;ID&gt;{$temp.tmp_MessageID/text()}&lt;/ID&gt;
&lt;CreationDateTime&gt;{$input.in_Payload[1]/PostDate}&lt;/CreationDateTime&gt;
                &lt;/MessageHeader&gt;
                &lt;JournalEntry&gt;               
                    &lt;CompanyCode&gt;{$input.in_Payload[1]/CompanyCode/text()}&lt;/CompanyCode&gt;              &lt;AccountingDocumentType&gt;DZ&lt;/AccountingDocumentType&gt;
                    &lt;DocumentDate&gt;{substring-before($input.in_Payload[1]/ValueDate,'T')}&lt;/DocumentDate&gt;
                    &lt;PostingDate&gt;{substring-before($input.in_Payload[1]/PostDate,'T')}&lt;/PostingDate&gt;   
                    &lt;DocumentHeaderText&gt;{'Cleared by API'}&lt;/DocumentHeaderText&gt;                                           &lt;CreatedByUser&gt;{$temp.tmp_CreatedBy/text()}&lt;/CreatedByUser&gt;
&lt;CurrencyCode&gt;{$input.in_Payload[1]/BankCurrency/text()}&lt;/CurrencyCode&gt;
                    {let $S4 := $output.gET_A_OperationalAcctgDocItemCubeResponse[1]/d[1]/results[1] return 
                    &lt;GLItems&gt;
                        &lt;ReferenceDocumentItem&gt;1&lt;/ReferenceDocumentItem&gt;
                        &lt;CompanyCode&gt;{$input.in_Payload[1]/CompanyCode/text()}&lt;/CompanyCode&gt;
						&lt;GLAccount&gt;{$input.in_Payload[1]/GL_CashReceipt_S4/text()}&lt;/GLAccount&gt;
                        &lt;FiscalYear&gt;{$S4/FiscalYear/text()}&lt;/FiscalYear&gt;                       
                        &lt;AccountingDocument&gt;{$S4/AccountingDocument/text()}&lt;/AccountingDocument&gt;                       
						&lt;AccountingDocumentItem&gt;{$S4/AccountingDocumentItem/text()}&lt;/AccountingDocumentItem&gt;
                    &lt;/GLItems&gt;}

                    {let $B1 := $input.in_Payload ,
                    	 $B1_Posted := $temp.tmp_MatchingItemsFeedback[1]/JournalEntryCreateConfirmation[1]/JournalEntryCreateConfirmation[1]
                    return 
                    &lt;GLItems&gt;
                        &lt;ReferenceDocumentItem&gt;2&lt;/ReferenceDocumentItem&gt;
                        &lt;CompanyCode&gt;{$B1_Posted/CompanyCode/text()} &lt;/CompanyCode&gt;
                        &lt;GLAccount&gt;{$B1/GL_CashReceipt_S4/text()}&lt;/GLAccount&gt;  
                        &lt;FiscalYear&gt;{util:iif(util:isNull($temp.tmp_FailedAtStep_Reason) or $temp.tmp_FailedAtStep_Reason='', $B1_Posted/FiscalYear/text(), util:iif($temp.tmp_FailedAtStep_Reason = 'JournalPosting', $B1_Posted/FiscalYear/text(), $output.FiscalYear ))}&lt;/FiscalYear&gt;                       
                        &lt;AccountingDocument&gt;{util:iif(util:isNull($temp.tmp_FailedAtStep_Reason) or $temp.tmp_FailedAtStep_Reason='', $B1_Posted/AccountingDocument/text(), util:iif($temp.tmp_FailedAtStep_Reason = 'JournalPosting', $B1_Posted/AccountingDocument/text(), $output.AccountingDocument ))}&lt;/AccountingDocument&gt;                       
						&lt;AccountingDocumentItem&gt;{util:iif(util:isNull($temp.tmp_FailedAtStep_Reason) or $temp.tmp_FailedAtStep_Reason='', 1, util:iif($temp.tmp_FailedAtStep_Reason = 'JournalPosting', '1', $output.AccountingDocumentItem))}&lt;/AccountingDocumentItem&gt;
                    &lt;/GLItems&gt;}                   
                &lt;/JournalEntry&gt;
            &lt;/JournalEntryClearingRequest&gt;
        &lt;/sfin:JournalEntryBulkClearingRequest&gt;
    &lt;/soapenv:Body&gt;
&lt;/soapenv:Envelope&gt;</expression>
                        </operation>
                        <link id="lfayk0lc" targetId="lfayk0k0"/>
                     </assignment>
                  </flow>
                  <link id="lfayk0ki" targetId="lfayk0j9" type="containerLink">
                     <condition source="formula">
                        <function name="greater-than">
                           <arg name="left">{$temp.tmp_S4Bank_Count}</arg>
                           <arg name="right">{1}</arg>
                        </function>
                     </condition>
                  </link>
                  <link id="lfayk0kj" targetId="lfayk0jd" type="containerLink">
                     <condition source="formula">
                        <function name="equals">
                           <arg name="left">{$temp.tmp_S4Bank_Count}</arg>
                           <arg name="right">{0}</arg>
                        </function>
                     </condition>
                  </link>
                  <link id="lfayk0kk" targetId="lfayk0jh" type="containerLink"/>
               </container>
            </flow>
         </process>
      </types1:Entry>
      <types1:GUID>7ZTYQCxRrdffaMNpebcWqL</types1:GUID>
      <types1:DisplayName>Process_BankClearing_SapB1-SapS4</types1:DisplayName>
   </types1:Item>
   <types1:CurrentServerDateTime>2023-09-16T18:19:18.542Z</types1:CurrentServerDateTime>
</aetgt:getResponse>
